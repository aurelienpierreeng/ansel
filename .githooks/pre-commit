#!/bin/bash
#   This file is part of darktable,
#   Copyright (C) 2019-2021 Pascal Obry.
#   Copyright (C) 2020 Heiko Bauke.
#   Copyright (C) 2020 Hubert Kowalski.
#   
#   darktable is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.
#   
#   darktable is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#   
#   You should have received a copy of the GNU General Public License
#   along with darktable.  If not, see <http://www.gnu.org/licenses/>.
#   
 Hash using its key as a search Regex, and its value as associated
 error message.
#   
declare -A PATTERNS;
PATTERNS['src/external/rawspeed']="use --no-verify to change rawspeed";
PATTERNS['src/external/OpenCL']="use --no-verify to change OpenCL";
PATTERNS['src/external/libxcf']="use --no-verify to change libxcf";
PATTERNS['src/external/whereami']="use --no-verify to change whereami";
PATTERNS['src/tests/integration']="use --no-verify to change integration";

# Loop over staged files and check for any specific pattern listed in
# PATTERNS keys.
# Filter only added (A), copied (C), modified (M) files

declare -a errors

for file in $(git diff --staged --name-only --diff-filter=ACM --no-color); do
    for elem in ${!PATTERNS[*]} ; do
        if [ -n "${PATTERNS[${file}]}" ]; then
            errors+=("${PATTERNS[${file}]}")
        fi
    done
done

# Print errors
for error in "${errors[@]}"; do
  echo -e "\033[1;31m${error}\033[0m"
done

# If there is any error, then stop commit creation
if [ ${#errors[@]} -ne 0 ]; then
  exit 1
fi

# Regenerate AUTHORS in repo root before committing
repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -n "$repo_root" ]; then
  gen_script="$repo_root/tools/release/generate-authors.sh"
  if [ -x "$gen_script" ]; then
    tmp_file=$(mktemp "${repo_root}/.git/authors.XXXXXX") || exit 1
    if "$gen_script" release-3.9.0 HEAD > "$tmp_file"; then
      if [ ! -f "$repo_root/AUTHORS" ] || ! cmp -s "$tmp_file" "$repo_root/AUTHORS"; then
        mv "$tmp_file" "$repo_root/AUTHORS"
        git add "$repo_root/AUTHORS"
        echo "Updated AUTHORS"
      else
        rm -f "$tmp_file"
      fi
    else
      echo "Warning: failed to regenerate AUTHORS" >&2
      rm -f "$tmp_file"
    fi
  fi
fi
